name: Terraform Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Environment'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code
  pull-requests: write # Optional: for posting plan comments

env:
  TF_VERSION: '1.9.8'
  AWS_REGION: 'us-east-1'

jobs:
  terraform:
    name: 'Terraform ${{ inputs.action }}'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    defaults:
      run:
        shell: bash
        working-directory: ./terraform
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}
          mask-aws-account-id: true
          
      - name: Verify AWS Identity
        run: |
          aws sts get-caller-identity
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
          
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true
          
      - name: Terraform Init
        run: terraform init
        env:
          TF_INPUT: false
          
      - name: Terraform Validate
        run: terraform validate
        
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -input=false \
            -out=tfplan \
            ${{ inputs.action == 'destroy' && '-destroy' || '' }} \
            -var="environment=${{ inputs.environment }}" \
            -no-color
        env:
          TF_INPUT: false
          TF_IN_AUTOMATION: true
        continue-on-error: false
        
      - name: Approval Required for Apply/Destroy
        if: inputs.action == 'apply' || inputs.action == 'destroy'
        run: |
          echo "::notice::Action '${{ inputs.action }}' requires manual approval in environment '${{ inputs.environment }}'"
          echo "Proceeding with ${{ inputs.action }}..."
          
      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: |
          terraform apply \
            -input=false \
            -auto-approve \
            tfplan
        env:
          TF_INPUT: false
          TF_IN_AUTOMATION: true
      
      - name: Extract Terraform Outputs
        if: inputs.action == 'apply'
        id: outputs
        run: |
          # Extract outputs and save to file
          mkdir -p ../deployment-config
          
          echo "Extracting Terraform outputs..."
          terraform output -json > ../deployment-config/terraform-outputs.json
          
          # Extract specific values for easy access
          INSTANCE_ID=$(terraform output -raw instance_id)
          CLOUDFRONT_URL=$(terraform output -raw cloudfront_url)
          IMAGE_URL=$(terraform output -raw image_url)
          ELASTIC_IP=$(terraform output -raw elastic_ip)
          SECRET_ARN=$(terraform output -raw secrets_manager_arn)
          
          # Create deployment config file
          cat > ../deployment-config/deployment.env << EOF
          INSTANCE_ID=$INSTANCE_ID
          CLOUDFRONT_URL=$CLOUDFRONT_URL
          IMAGE_URL=$IMAGE_URL
          ELASTIC_IP=$ELASTIC_IP
          SECRETS_MANAGER_ARN=$SECRET_ARN
          ENVIRONMENT=${{ inputs.environment }}
          AWS_REGION=${{ env.AWS_REGION }}
          DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF
          
          echo "Deployment configuration saved"
          cat ../deployment-config/deployment.env
          
          # Set outputs for workflow
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "image_url=$IMAGE_URL" >> $GITHUB_OUTPUT
      
      - name: Upload Deployment Configuration
        if: inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-config-${{ inputs.environment }}
          path: deployment-config/
          retention-days: 30
      
      - name: Display Deployment Info
        if: inputs.action == 'apply'
        run: |
          echo "============================================"
          echo "üéâ Infrastructure Deployed Successfully!"
          echo "============================================"
          echo ""
          echo "üì¶ Instance ID: ${{ steps.outputs.outputs.instance_id }}"
          echo "üåê CloudFront URL: ${{ steps.outputs.outputs.cloudfront_url }}"
          echo "üì∏ Image URL: ${{ steps.outputs.outputs.image_url }}"
          echo ""
          echo "Next Steps:"
          echo "1. Run 'Ansible Deployment' workflow"
          echo "2. Select environment: ${{ inputs.environment }}"
          echo "3. Configuration will be auto-loaded from artifacts"
          echo "============================================"
          
      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: |
          terraform destroy \
            -input=false \
            -auto-approve \
            -var="environment=${{ inputs.environment }}"
        env:
          TF_INPUT: false
          TF_IN_AUTOMATION: true
          
      - name: Cleanup Plan File
        if: always()
        run: |
          rm -f tfplan
          
      - name: Security Scan with tfsec
        if: inputs.action == 'plan'
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ./terraform
          soft_fail: false
          
      - name: Run Checkov Security Scan
        if: inputs.action == 'plan'
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ./terraform
          framework: terraform
          soft_fail: false
          download_external_modules: true
