name: Vulnerability Scanning

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - staging
          - prod
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  id-token: write   # Required for OIDC
  contents: read
  security-events: write  # For uploading SARIF results

env:
  AWS_REGION: 'us-east-1'

jobs:
  scan-infrastructure:
    name: 'Scan Infrastructure'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Run Trivy vulnerability scanner in IaC mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: './terraform'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          
      - name: Upload Trivy IaC results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-iac-results.sarif'
          category: 'trivy-iac'
          
  scan-running-instance:
    name: 'Scan Running EC2 Instance'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-VulnScan-${{ github.run_id }}
          mask-aws-account-id: true
          
      - name: Get Instance ID from SSM Parameter
        id: get-instance
        run: |
          # Try to get instance ID from terraform output or SSM parameter
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=ssm-secure-machine" \
                      "Name=tag:Environment,Values=${{ inputs.environment || 'dev' }}" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)
          
          if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "::error::No running instance found"
            exit 1
          fi
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Found instance: $INSTANCE_ID"
          
      - name: Run AWS Inspector Scan
        id: inspector
        run: |
          INSTANCE_ID="${{ steps.get-instance.outputs.instance_id }}"
          
          echo "Starting AWS Inspector scan for instance: $INSTANCE_ID"
          
          # Check if Inspector is enabled
          aws inspector2 batch-get-account-status --account-ids $(aws sts get-caller-identity --query Account --output text) || {
            echo "::warning::AWS Inspector is not enabled. Enable it in AWS Console for vulnerability scanning."
          }
          
      - name: Run SSM Run Command - Security Scan
        id: ssm-scan
        run: |
          INSTANCE_ID="${{ steps.get-instance.outputs.instance_id }}"
          
          echo "Running security audit on instance: $INSTANCE_ID"
          
          # Run security audit using SSM
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE_ID" \
            --parameters 'commands=[
              "#!/bin/bash",
              "echo \"=== Security Audit Report ===\"",
              "echo \"Date: $(date)\"",
              "echo \"\"",
              "echo \"=== System Updates ===\"",
              "if command -v yum &> /dev/null; then",
              "  yum check-update --security 2>&1 | head -20",
              "elif command -v apt &> /dev/null; then",
              "  apt list --upgradable 2>&1 | head -20",
              "fi",
              "echo \"\"",
              "echo \"=== Open Ports ===\"",
              "ss -tuln | head -20",
              "echo \"\"",
              "echo \"=== Running Services ===\"",
              "systemctl list-units --type=service --state=running | head -20",
              "echo \"\"",
              "echo \"=== Failed Login Attempts (last 24h) ===\"",
              "if [ -f /var/log/secure ]; then",
              "  grep \"Failed password\" /var/log/secure | tail -10 || echo \"None found\"",
              "fi",
              "echo \"\"",
              "echo \"=== Disk Usage ===\"",
              "df -h | grep -v tmpfs",
              "echo \"\"",
              "echo \"=== Security Packages ===\"",
              "rpm -qa | grep -E \"(aide|ossec|fail2ban|rkhunter)\" || echo \"No security packages detected\""
            ]' \
            --comment "Security audit via GitHub Actions" \
            --output-s3-bucket-name "terr-backend-69" \
            --output-s3-key-prefix "security-scans/${{ inputs.environment || 'dev' }}/$(date +%Y%m%d)" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          
          # Wait for command to complete
          echo "Waiting for command to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --timeout 300 || {
              echo "::warning::Command timed out or failed"
            }
          
          # Get command output
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardOutputContent" \
            --output text)
          
          echo "=== Scan Results ==="
          echo "$OUTPUT"
          
      - name: Check for Critical Vulnerabilities
        run: |
          INSTANCE_ID="${{ steps.get-instance.outputs.instance_id }}"
          
          # Get security patches pending
          PENDING_PATCHES=$(aws ssm describe-instance-patches \
            --instance-id "$INSTANCE_ID" \
            --filters "Key=State,Values=Missing" \
            --query "length(Patches)" \
            --output text 2>/dev/null || echo "0")
          
          echo "Pending security patches: $PENDING_PATCHES"
          
          if [ "$PENDING_PATCHES" -gt 10 ]; then
            echo "::error::Instance has $PENDING_PATCHES pending patches. Consider patching."
          elif [ "$PENDING_PATCHES" -gt 0 ]; then
            echo "::warning::Instance has $PENDING_PATCHES pending patches."
          else
            echo "::notice::Instance is up to date!"
          fi
          
      - name: Generate Security Report
        run: |
          cat > security-report.md <<EOF
          # Security Scan Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Environment:** ${{ inputs.environment || 'dev' }}
          **Instance ID:** ${{ steps.get-instance.outputs.instance_id }}
          
          ## Scan Results
          
          -  Infrastructure code scanned with Trivy
          -  AWS Inspector check completed
          -  SSM security audit completed
          -  Patch status checked
          
          ## Recommendations
          
          1. Review SARIF results in GitHub Security tab
          2. Apply pending security patches if any
          3. Enable AWS Inspector for continuous scanning
          4. Schedule regular vulnerability scans
          
          ## Next Steps
          
          - Review findings in GitHub Security tab
          - Check S3 bucket \`terr-backend-69\` for detailed SSM scan logs
          - Apply patches: \`aws ssm send-command --document-name AWS-RunPatchBaseline --instance-ids ${{ steps.get-instance.outputs.instance_id }}\`
          EOF
          
          cat security-report.md
          
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ inputs.environment || 'dev' }}
          path: security-report.md
          retention-days: 30
